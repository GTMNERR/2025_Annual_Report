#| label: tbl-cmecs
#| tbl-cap: Coastal and Marine Ecological Standard CMECS Classifications for the four GTM Research Reserve long-term water quality monitoring stations, Pine Island (GTMPIWQ), San Sebastian (GTMSSWQ), Fort Matanzas (GTMFMWQ), and Pellicer Creek (GTMPCWQ).
library(here)
library(kableExtra)
library(readxl)
cmecs <- readxl::read_xlsx(here('data', 'cmecs.xlsx'))
cmecs |> kbl(align = "c") |>
kable_styling(fixed_thead = T, full_width = TRUE, font_size = 7) |>
row_spec(0, bold = T) |>
column_spec(1, border_right = T) |>
kable_classic(c('striped', 'hover'), full_width = T)
#| label: tbl-cmecs
#| tbl-cap: Coastal and Marine Ecological Standard CMECS Classifications for the four GTM Research Reserve long-term water quality monitoring stations, Pine Island (GTMPIWQ), San Sebastian (GTMSSWQ), Fort Matanzas (GTMFMWQ), and Pellicer Creek (GTMPCWQ).
library(here)
library(kableExtra)
library(readxl)
cmecs <- readxl::read_xlsx(here('data', 'cmecs.xlsx'))
cmecs |> kbl(align = "c") |>
kable_styling(fixed_thead = T, full_width = TRUE, font_size = 8) |>
row_spec(0, bold = T) |>
column_spec(1, border_right = T) |>
kable_classic(c('striped', 'hover'), full_width = T)
#| label: session-info
#| echo: false
sessionInfo()
# be sure to check for packages conflicts!
# 01 import/export ----
library(readxl) # read excel files
library(janitor) # simple tools to clean dirty data
library(here) # a simpler way to find your files
library(SWMPr) # working with SWMP data from the NERRS
library(SWMPrExtension) # expanded plotting and analysis of SWMP data from NERRS
# library(xlsx) # to export df as .xlsx files
# 02 tidy and wrangle ----
library(tidyverse) # because...tidyverse (ggplot2, tidyr, dplyr)
library(lubridate) # dates and times
library(weathermetrics) # functions to convert between weather metrics
library(cimir) # to convert wind direction degrees to cardinal directions/compass
# 03 pulling information and statistics ----
# library(broom) # convert statistical analysis objects into tidy tibbles
# library(psych)
# library(wql)
# 04 markdown ----
library(knitr)
library(kableExtra) # https://cran.r-project.org/web/packages/kableExtra/vignettes/awesome_table_in_html.html
# 05 graphics ----
library(khroma) # color-blind friendly palettes
library(patchwork) # grid graphics
library(scales) # scale functions for visualization
library(plotly) # create interactive web graphics - use for html output files
library(gganimate) # create animated web graphics
library(dygraphs) # create dynamic graphics
library(gghighlight) # allows for highlighting flexibility in ggplot2
library(ggthemes) # colorblind palettes
# 06 mapping ---------------------------------------------------------------
# library(leaflet)
# library(htmltools)
# library(sf)
# visual customizations for plots
# ----01 create custom labels for plots----
# create label for chlorophyll plots
chla_y_title <- expression(paste("Chlorophyll ", italic("a "), mu*"g/L"))
# create label for phosphorus plots
phos_y_title <- expression(paste("Total Phosphorus mg/L"))
# create label for nitrogen plots
nitro_y_title <- expression(paste("Total Nitrogen mg/L"))
# create label for fecal plots
fecal_y_title <- expression(paste("Fecal coliform CFU/100mL"))
# create label for enterococcus plots
entero_y_title <- expression(paste("Enterococcus MPN/100mL"))
# create label for temperature title
temp_y_title <- expression(paste("Temperature ("*~degree*C*")"))
nms <- names(read_excel(here::here('data',
'swmp',
# 'All_inclusive_NUT',
'gtmnut2002-2025_QC_zeros-corrected.xlsx'),
n_max = 0)) # pull out all the column names in this file
class <- ifelse(grepl("^F_", nms), "text", "numeric") # read everything with F_ as a character
class2 <- class[-(1:5)] # remove the first five elements of the vector because they are different
NUT <- readxl::read_xlsx(here::here('data',
'swmp',
# 'All_inclusive_NUT',
'gtmnut2002-2025_QC_zeros-corrected.xlsx'),
col_types = c("text",
"date",
"numeric",
"numeric",
"text",
class2)) %>% # specify how to read in these columns
janitor::clean_names()
# clean environment
rm(nms, class, class2)
# 02 wrangle data for merging ------------------------------------------------
NUT <- NUT %>% filter(!is.na(rep)) # remove "S" reps in dataset
# 04 wrangle to swmpr -----------------------------------------------------
# The `swmpr()` call needs to have just datetimestamp and data+qa columns, so remove the extras, while also making names lower case.
timezone <- "America/Jamaica" # needs a timezone
stations <- c("gtmpinut", "gtmssnut", "gtmfmnut", "gtmpcnut")
for (i in 1:length(stations)){
tempdf <- swmpr(as.data.frame(NUT %>%
filter(station_code == stations[i]) %>%
select(-station_code) %>%
mutate(date_time_stamp = as.POSIXct(date_time_stamp,
tz = timezone,
format = '%m/%d/%Y %H:%M')) %>%
rename(datetimestamp = date_time_stamp,
unc_chla_n = unc_ch_la_n,
f_unc_chla_n = f_unc_ch_la_n) %>%
filter(monitoring_program == 1) %>%
select(-monitoring_program, -rep)),
stations[i])
#
name <- attr(tempdf, "station") # pull out the name you want of the file
#
assign(paste0("swmp", "_", name), tempdf)
rm(tempdf, name, i)
}
# check object(s) to confirm they are swmpr objects
# class(swmp_gtmpcnut)
# str(swmp_gtmpcnut)
rm(timezone, stations)
## 04.2 qaqc swmpr --------------------------------------------------------
# use the qaqc functions on the data
pi_nut_1 <- swmp_gtmpinut %>% SWMPr::qaqc(qaqc_keep = c('0', '2', '3', '4', '5'))
ss_nut_1 <- swmp_gtmssnut %>% SWMPr::qaqc(qaqc_keep = c('0', '2', '3', '4', '5'))
fm_nut_1 <- swmp_gtmfmnut %>% SWMPr::qaqc(qaqc_keep = c('0', '2', '3', '4', '5'))
pc_nut_1 <- swmp_gtmpcnut %>% SWMPr::qaqc(qaqc_keep = c('0', '2', '3', '4', '5'))
# filter timestamp so the file ends at the quarter
pi_nut <- subset(pi_nut_1, subset = '2025-11-01 0:00', operator = '<')
ss_nut <- subset(ss_nut_1, subset = '2025-11-01 0:00', operator = '<')
fm_nut <- subset(fm_nut_1, subset = '2025-11-01 0:00', operator = '<')
pc_nut <- subset(pc_nut_1, subset = '2025-11-01 0:00', operator = '<')
# remove unfiltered data objects
rm(swmp_gtmpinut,
swmp_gtmssnut,
swmp_gtmfmnut,
swmp_gtmpcnut)
# 05 aggregate to monthly -------------------------------------------------
pi_nut_mo <- pi_nut %>% aggreswmp(by = "months")
ss_nut_mo <- ss_nut %>% aggreswmp(by = "months")
fm_nut_mo <- fm_nut %>% aggreswmp(by = "months")
pc_nut_mo <- pc_nut %>% aggreswmp(by = "months")
# merge together
# NUT_f <- bind_rows("gtmpinut" = pi_nut_mo,
#                    "gtmssnut" = ss_nut_mo,
#                    "gtmfmnut" = fm_nut_mo,
#                    "gtmpcnut" = pc_nut_mo,
#                    .id = "station_code")
NUT_monthly <- bind_rows("gtmpinut" = pi_nut_mo,
"gtmssnut" = ss_nut_mo,
"gtmfmnut" = fm_nut_mo,
"gtmpcnut" = pc_nut_mo,
.id = "station_code") %>%
# select(station_code, datetimestamp, tn, tp, chla_n, tkn, po4f, din) %>%
dplyr::mutate(year = lubridate::year(datetimestamp),
month_abb = lubridate::month(datetimestamp, label = TRUE, abbr = TRUE),
month = lubridate::month(datetimestamp),
station_code = factor(station_code,
levels = c("gtmpinut",
"gtmssnut",
"gtmfmnut",
"gtmpcnut")))
### 05.3.2 monthly averages to yearly ----
# annual geometric mean function
# gmean <- function(x) exp(mean(log(x), na.rm = TRUE))
# or use the psych::geometric.mean() function
NUT_yearly <- NUT_monthly %>%
dplyr::group_by(station_code, year) %>%
dplyr::summarise(TN_agm = psych::geometric.mean(tn, na.rm = T),
TP_agm = psych::geometric.mean(tp, na.rm = T),
CHLA_agm = psych::geometric.mean(chla_n, na.rm = T)) %>%
dplyr::ungroup() %>%
dplyr::mutate(year = forcats::as_factor(year))
pi_1 <- SWMPr::import_local(path = here::here('data',
'swmp'),
station_code = 'gtmpiwq') %>%
SWMPr::qaqc(qaqc_keep = c('0', '2', '3', '4', '5'))
pi <- subset(pi_1, subset = '2025-11-01 0:00', operator = '<')
ss_1 <- SWMPr::import_local(path = here::here('data',
'swmp'),
station_code = 'gtmsswq') %>%
SWMPr::qaqc(qaqc_keep = c('0', '2', '3', '4', '5'))
ss <- subset(ss_1, subset = '2025-11-01 0:00', operator = '<')
fm_1 <- SWMPr::import_local(path = here::here('data',
'swmp'),
station_code = 'gtmfmwq', trace = TRUE) %>%
SWMPr::qaqc(qaqc_keep = c('0', '2', '3', '4', '5'))
fm <- subset(fm_1, subset = '2025-11-01 0:00', operator = '<')
pc_1 <- SWMPr::import_local(path = here::here('data',
'swmp'),
station_code = 'gtmpcwq') %>%
SWMPr::qaqc(qaqc_keep = c('0', '2', '3', '4', '5'))
pc <- subset(pc_1, subset = '2025-11-01 0:00', operator = '<')
MET_1 <- SWMPr::import_local(path = here::here('data',
'swmp'),
station_code = 'gtmpcmet', trace = TRUE) %>%
SWMPr::qaqc(qaqc_keep = c('0', '2', '3', '4', '5'))
MET <- subset(MET_1, subset = '2025-11-01 0:00', operator = '<')
# 02 wrangle data for merging ------------------------------------------------
# choose to add station name to the file for merging
pi2 <- pi %>% dplyr::mutate(station = 'gtmpiwq')
ss2 <- ss %>% dplyr::mutate(station = 'gtmsswq')
fm2 <- fm %>% dplyr::mutate(station = 'gtmfmwq')
pc2 <- pc %>% dplyr::mutate(station = 'gtmpcwq')
# plus MET
# MET <- MET %>% dplyr::mutate(station = 'gtmpcmet')
# combine all stations into one df (helpful to add station name)
WQ <- dplyr::bind_rows(pi2, ss2, fm2, pc2)
# choose to keep or remove individual stations
rm(pi2, ss2, fm2, pc2)
# 99 export as .RData -----------------------------------------------------
## uncomment below to export as .RData for use later.
save(WQ, file = here::here('output', 'data', 'WQ.RData'))
save(MET, file = here::here('output', 'data', 'MET.RData'))
save(pi, file = here::here('output', 'data', 'pi_wq.RData'))
save(ss, file = here::here('output', 'data', 'ss_wq.RData'))
save(fm, file = here::here('output', 'data', 'fm_wq.RData'))
save(pc, file = here::here('output', 'data', 'pc_wq.RData'))
boxplot_currentyear <- function(station, param, threshold, thres_val) {
# parameters: station, param, threshold, thres_val
if (threshold == TRUE) {
boxplot <- ggplot(data = NUT_monthly,
aes(x = month_abb, y = {{param}})) +
geom_boxplot(data = filter(NUT_monthly, station_code == station & year < 2025),
aes(fill = "2002-2024")) +
geom_point(data = filter(NUT_monthly, station_code == station & year == 2025),
aes(color = "2025"),
size = 4) +
geom_hline(yintercept = thres_val, color = "blue",
linetype = "dashed") +
scale_color_manual(name = "",
values = c("2025" = "red")) +
scale_fill_manual(name = "",
values = c("2002-2024" = "white")) +
theme_classic() +
theme(legend.position = "bottom",
axis.text = element_text(color = "black")) +
labs(x = "")
boxplot
} else {
boxplot <- ggplot(data = NUT_monthly,
aes(x = month_abb, y = {{param}})) +
geom_boxplot(data = filter(NUT_monthly, station_code == station & year < 2025),
aes(fill = "2002-2024")) +
geom_point(data = filter(NUT_monthly, station_code == station & year == 2025),
aes(color = "2025"),
size = 4) +
scale_color_manual(name = "",
values = c("2025" = "red")) +
scale_fill_manual(name = "",
values = c("2002-2024" = "white")) +
theme_classic() +
theme(legend.position = "bottom",
axis.text = element_text(color = "black")) +
labs(x = "")
boxplot
}
}
## 01.2 yearly agms ----
agm <- function(station, param, threshold, thres_val) {
# label y axis with ex: "Geo.Mean Annual Chlorophyll-a (\U00B5g/L)"
if (threshold == TRUE) {
agm <- NUT_yearly  %>%
dplyr::filter(station_code == station) %>%
ggplot(aes(x = year, y = {{param}}, group = 1)) +
geom_line() +
geom_point(aes(color = {{param}} > thres_val), size = 3) +
geom_hline(yintercept = thres_val, color = "blue",
linetype = "dashed") +
scale_color_manual(name = "", values = c("black", "red")) +
theme_classic() +
theme(legend.position = "none",
axis.text = element_text(color = "black"),
axis.text.x = element_text(angle = 45,
vjust = 0.6)) +
labs(x = "")
agm
} else {
agm <- NUT_yearly  %>%
dplyr::filter(station_code == station) %>%
ggplot(aes(x = year, y = {{param}}, group = 1)) +
geom_line() +
geom_point(size = 3) +
scale_color_manual(name = "", values = c("black", "red")) +
theme_classic() +
theme(legend.position = "none",
axis.text = element_text(color = "black"),
axis.text.x = element_text(angle = 45,
vjust = 0.6)) +
labs(x = "")
agm
}
}
library(leaflet)
library(htmltools)
library(sf)
library(dplyr)
library(janitor)
library(here)
station_info <- readr::read_csv(here::here('data', 'swmp',
'sampling_stations.csv')) %>% janitor::clean_names()
glimpse(station_info)
spatial <- station_info %>%
filter(grepl("gtm",nerr_site_id)) %>%
filter(!grepl("nut", station_code)) %>%
select(station_code, latitude, longitude) %>%
mutate(longitude = as.numeric(longitude))
spatial<- spatial %>%
mutate(longitude = longitude*(-1))
shape_data <- st_read(here::here('data',
'shapefiles',
'qa_4269_GTM_RB_2014_simplified_DLE.shp'))
# spatial %>%
#   leaflet(width = 900) %>%
#   addTiles() %>%
#   addMarkers(clusterOptions = markerClusterOptions(),
#              label = ~htmlEscape(station_code),
#              labelOptions = labelOptions(textsize = "15px")) %>%
#   addPolygons(data = shape_data, weight = 5, col = 'red')
# addWMSTiles(
#   "http://mesonet.agron.iastate.edu/cgi-bin/wms/nexrad/n0r.cgi",
#   layers = "nexrad-n0r-900913",
#   options = WMSTileOptions(format = "image/png", transparent = TRUE),
#   attribution = "Weather data Â© 2012 IEM Nexrad"
# )
